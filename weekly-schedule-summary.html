<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å“¡å·¥è¡Œç¨‹ç¸½è¦½ï¼ˆGoogle Sheetsï¼‰</title>
  <style>
    body {
      font-family: 'Noto Sans TC', Arial, sans-serif;
      background: #f7f7fa;
      margin: 0;
      padding: 0;
    }
    #schedule-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
      justify-content: flex-start;
      padding: 32px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px #0001;
      padding: 24px;
      min-width: 350px;
      max-width: 420px;
      flex: 1 1 350px;
      display: flex;
      flex-direction: column;
    }
    .card h2 {
      margin: 0 0 12px 0;
      font-size: 1.3em;
      color: #2d3a4a;
    }
    .week-table {
      width: 100%;
      border-collapse: collapse;
    }
    .week-table th, .week-table td {
      border: 1px solid #e0e0e0;
      padding: 6px 8px;
      text-align: left;
      font-size: 0.98em;
    }
    .week-table th {
      background: #f0f4f8;
      color: #3a4a5a;
    }
    .day-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .day-list li {
      margin-bottom: 4px;
      padding: 2px 0;
      border-bottom: 1px dashed #e0e0e0;
      font-size: 0.97em;
    }
    .day-list li:last-child {
      border-bottom: none;
    }
    @media (max-width: 900px) {
      #schedule-cards {
        flex-direction: column;
        gap: 20px;
        padding: 10px;
      }
      .card {
        min-width: unset;
        max-width: unset;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h2>ğŸ“‹ å“¡å·¥è¡Œç¨‹ç¸½è¦½ï¼ˆè‡ªå‹•è®€å– Google Sheetsï¼‰</h2>
  <div id="company-stats" style="padding:24px 32px 0 32px;font-size:1.2em;"></div>
  <div id="schedule-cards"></div>
  <script>
    // ä½ çš„ Google Sheets CSV é€£çµ
    const csvUrl = 'https://corsproxy.io/?https://docs.google.com/spreadsheets/d/e/2PACX-1vTO8x9b16DUvF4fNI2J0fYUQUbrbYoA5eSzIuKP3bVG0ZXZjEk3Do3cjdBAKANWinQilF1WfReO_ysW/pub?output=csv';

    // è§£æ CSV
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      return lines.map(line => {
        const cells = [];
        let inQuotes = false, cell = '';
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) {
            cells.push(cell);
            cell = '';
          } else {
            cell += char;
          }
        }
        cells.push(cell);
        return cells;
      });
    }

    // ä¾å“¡å·¥åˆ†çµ„ã€ä¾æ—¥æœŸåˆ†å¤©
    function groupByEmployeeAndDay(rows) {
      if (!rows || rows.length < 2) return {};
      const header = rows[0];
      const nameIdx = header.findIndex(h => h.includes('å§“å'));
      const dateIdx = header.findIndex(h => h.includes('æ—¥æœŸ'));
      const clientIdx = header.findIndex(h => h.includes('å®¢æˆ¶'));
      const contentIdx = header.findIndex(h => h.includes('å…§å®¹'));
      const startTimeIdx = header.findIndex(h => h.includes('å‡ºå‹¤æ™‚é–“'));
      const endTimeIdx = header.findIndex(h => h.includes('å›å…¬å¸æ™‚é–“'));
      const startKmIdx = header.findIndex(h => h.includes('å‡ºç™¼Km'));
      const endKmIdx = header.findIndex(h => h.includes('å›ä¾†Km'));
      const fuelKmIdx = header.findIndex(h => h.includes('åŠ æ²¹å…¬é‡Œæ•¸'));
      const fuelLIdx = header.findIndex(h => h.includes('åŠ æ²¹å…¬å‡'));
      const latlngIdx = header.findIndex(h => h.includes('ç¶“ç·¯åº¦'));
      const imgIdx = header.findIndex(h => h.includes('åœ–ç‰‡'));
      const empMap = {};
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length < 2) continue;
        const name = row[nameIdx] || 'æœªå¡«å§“å';
        const date = row[dateIdx] || '';
        if (!name || !date) continue;
        if (!empMap[name]) empMap[name] = {};
        if (!empMap[name][date]) empMap[name][date] = [];
        empMap[name][date].push({
          client: row[clientIdx] || '',
          content: row[contentIdx] || '',
          startTime: row[startTimeIdx] || '',
          endTime: row[endTimeIdx] || '',
          startKm: row[startKmIdx] || '',
          endKm: row[endKmIdx] || '',
          fuelKm: row[fuelKmIdx] || '',
          fuelL: row[fuelLIdx] || '',
          latlng: row[latlngIdx] || '',
          img: row[imgIdx] || ''
        });
      }
      return empMap;
    }

    // ç”¢ç”Ÿå¡ç‰‡
    function renderCards(empMap) {
      const container = document.getElementById('schedule-cards');
      container.innerHTML = '';
      if (!empMap || Object.keys(empMap).length === 0) {
        container.innerHTML = '<p>ç›®å‰æ²’æœ‰ä»»ä½•è¡Œç¨‹è³‡æ–™ã€‚</p>';
        return;
      }
      Object.keys(empMap).forEach(name => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h2>${name}</h2>
          <table class="week-table">
            <tr>
              <th>æ—¥æœŸ</th>
              <th>è¡Œç¨‹</th>
            </tr>
            ${Object.keys(empMap[name]).map(date => {
              return empMap[name][date].map(item => `
                <tr>
                  <td>${date}</td>
                  <td>
                    <ul class="day-list">
                      <li>å®¢æˆ¶ï¼š${item.client}</li>
                      <li>å…§å®¹ï¼š${item.content}</li>
                      <li>å‡ºå‹¤ï¼š${item.startTime}</li>
                      <li>å›å…¬å¸ï¼š${item.endTime}</li>
                      <li>å‡ºç™¼Kmï¼š${item.startKm}</li>
                      <li>å›ä¾†Kmï¼š${item.endKm}</li>
                      <li>åŠ æ²¹Kmï¼š${item.fuelKm}ï¼Œå…¬å‡ï¼š${item.fuelL}</li>
                      <li>åº§æ¨™ï¼š${item.latlng}</li>
                      <li>åœ–ç‰‡ï¼š${item.img ? `<a href="${item.img}" target="_blank">æŸ¥çœ‹</a>` : ''}</li>
                    </ul>
                  </td>
                </tr>
              `).join('');
            }).join('')}
          </table>
        `;
        container.appendChild(card);
      });
    }

    // ä¸»æµç¨‹
    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        const rows = parseCSV(csvText);
        const empMap = groupByEmployeeAndDay(rows);
        renderCompanyStats(rows);
        renderCards(empMap);
      })
      .catch(err => {
        document.getElementById('schedule-cards').innerHTML = '<p>è®€å– Google è¡¨å–®è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£çµæˆ–ç¶²è·¯ã€‚</p>';
        document.getElementById('company-stats').innerHTML = '';
        console.error('fetchå¤±æ•—:', err);
      });

    // æ–°å¢ï¼šå…¨å…¬å¸çµ±è¨ˆå€å¡Š
    function renderCompanyStats(rows) {
      if (!rows || rows.length < 2) {
        document.getElementById('company-stats').innerHTML = '';
        return;
      }
      const header = rows[0];
      const startKmIdx = header.findIndex(h => h.includes('å‡ºç™¼Km'));
      const endKmIdx = header.findIndex(h => h.includes('å›ä¾†Km'));
      const fuelLIdx = header.findIndex(h => h.includes('åŠ æ²¹å…¬å‡'));
      const clientIdx = header.findIndex(h => h.includes('å®¢æˆ¶'));
      let totalKm = 0, totalFuel = 0, totalRoutes = 0;
      const hospitalSet = new Set();
      const schoolSet = new Set();
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length < 2) continue;
        const start = Number(row[startKmIdx]) || 0;
        const end = Number(row[endKmIdx]) || 0;
        if (end > start) totalKm += (end - start);
        totalFuel += Number(row[fuelLIdx]) || 0;
        totalRoutes++;
        const client = (row[clientIdx] || '').trim();
        if (client.includes('é†«é™¢')) hospitalSet.add(client);
        if (client.includes('å­¸æ ¡')) schoolSet.add(client);
      }
      document.getElementById('company-stats').innerHTML =
        `<b>å…¨å…¬å¸æœ¬é€±çµ±è¨ˆï¼š</b> ç¸½å…¬é‡Œæ•¸ï¼š<b>${totalKm}</b> kmã€€|ã€€ç¸½åŠ æ²¹å…¬å‡ï¼š<b>${totalFuel}</b> Lã€€|ã€€ç¸½è¡Œç¨‹æ•¸ï¼š<b>${totalRoutes}</b><br>
        æ‹œè¨ªé†«é™¢æ•¸ï¼š<b>${hospitalSet.size}</b>ã€€|ã€€æ‹œè¨ªå­¸æ ¡æ•¸ï¼š<b>${schoolSet.size}</b><br>
        <span style="color:#357abd">é†«é™¢ï¼š</span> ${[...hospitalSet].join('ã€') || 'ç„¡'}<br>
        <span style="color:#357abd">å­¸æ ¡ï¼š</span> ${[...schoolSet].join('ã€') || 'ç„¡'}`;
    }
  </script>
</body>
</html>
